#
# Only N images will be kept in the Container Registry (if older than 1 day).
# The cleanup task is ran as part of each pipeline execution.
#

name: Storybook - Build and Deploy
run-name: Storybook - Build and Deploy [${{ github.event.inputs.ENVIRONMENT || 'demo' }}]

env:
  ACR_REGISTRY_NAME: vsbdevtest.azurecr.io
  NUMBER_OF_IMAGES_TO_KEEP: 5
  SUBSCRIPTION_ID: 84643fb7-3439-48b6-96f2-8b50565881fc
  SKIP_BUILD: ${{ github.event.inputs.SKIP_BUILD || false }}

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - demo
          - test
        default: demo
      BRANCH:
        description: "Branch to deploy (only for test environment)"
        required: false
        type: string
        default: main
      SKIP_BUILD:
        description: "Skip build and deploy latest image"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  setup:
    name: Setup environment variables
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.set-vars.outputs.env_name }}
      azure_prefix: ${{ steps.set-vars.outputs.azure_prefix }}
      image_name: ${{ steps.set-vars.outputs.image_name }}
      sku: ${{ steps.set-vars.outputs.sku }}
      branch: ${{ steps.set-vars.outputs.branch }}
      image_tag: ${{ steps.set-vars.outputs.image_tag }}

    steps:
      - name: Set environment variables
        id: set-vars
        run: |
          # Determine environment (push = demo, workflow_dispatch = from input)
          if [ "${{ github.event_name }}" == "push" ]; then
            ENV_NAME="demo"
            BRANCH="main"
          else
            ENV_NAME="${{ github.event.inputs.ENVIRONMENT }}"
            BRANCH="${{ github.event.inputs.BRANCH }}"
          fi

          # Set variables based on environment
          if [ "$ENV_NAME" == "test" ]; then
            AZURE_PREFIX="vsbstorybook-test"
            IMAGE_NAME="vsb-cds-react-storybook-test"
            SKU="B1"
          else
            AZURE_PREFIX="vsbstorybook"
            IMAGE_NAME="vsb-cds-react-storybook"
            SKU="P0V3"
          fi

          # Determine image tag
          if [ "${{ env.SKIP_BUILD }}" == "true" ]; then
            IMAGE_TAG="latest"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi

          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "azure_prefix=$AZURE_PREFIX" >> $GITHUB_OUTPUT
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "sku=$SKU" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "### Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- **Azure Prefix**: $AZURE_PREFIX" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Name**: $IMAGE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **SKU**: $SKU" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: setup
    environment:
      name: ${{ needs.setup.outputs.env_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup.outputs.branch }}

      - name: Set up Docker Buildx
        if: env.SKIP_BUILD == 'false'
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - name: Login via Azure CLI
        if: env.SKIP_BUILD == 'false'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials
        if: env.SKIP_BUILD == 'false'
        id: get-acr-credentials
        run: |
          ACR_USERNAME=$(az acr credential show -n ${{ env.ACR_REGISTRY_NAME }} --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show -n ${{ env.ACR_REGISTRY_NAME }} --query "passwords[0].value" -o tsv)
          echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_ENV
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_ENV

      - name: Azure Container Registry Login
        if: env.SKIP_BUILD == 'false'
        uses: Azure/docker-login@v2
        with:
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}
          login-server: ${{ env.ACR_REGISTRY_NAME }}

      - name: Purge images in container registry - keep ${{ env.NUMBER_OF_IMAGES_TO_KEEP }}
        if: env.SKIP_BUILD == 'false'
        uses: Azure/cli@v2.1.0
        with:
          inlineScript: |
            PURGE_CMD="acr purge --filter '${{ needs.setup.outputs.image_name }}:.*' --ago 1d --keep ${{ env.NUMBER_OF_IMAGES_TO_KEEP }}"
            az acr run --cmd "$PURGE_CMD" --registry ${{ env.ACR_REGISTRY_NAME }} /dev/null

      - name: Build and push container image to registry
        if: env.SKIP_BUILD == 'false'
        uses: docker/build-push-action@0565240e2d4ab88bba5387d719585280857ece09 # v5.0.0
        with:
          push: true
          context: .
          tags: |
            ${{ env.ACR_REGISTRY_NAME }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.image_tag }}
            ${{ env.ACR_REGISTRY_NAME }}/${{ needs.setup.outputs.image_name }}:latest
          file: Dockerfile
          build-args: |
            NPM_AUTH_TOKEN=${{ secrets.VSB_NPM_AUTH_TOKEN }}
            NPM_AUTH_EMAIL=${{ secrets.VSB_NPM_AUTH_EMAIL }}

  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [setup, build]
    environment:
      name: ${{ needs.setup.outputs.env_name }}
      url: ${{ steps.bicep-deploy.outputs.webAppUrl }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup.outputs.branch }}

      - name: Log into Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create --name vsb-${{ needs.setup.outputs.azure_prefix }}-rg --location francecentral

      - name: Bicep Deploy
        id: bicep-deploy
        uses: Azure/bicep-deploy@v2
        with:
          type: deployment
          operation: create
          name: infra
          scope: resourceGroup
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
          resource-group-name: vsb-${{ needs.setup.outputs.azure_prefix }}-rg
          template-file: ./infra/infra.bicep
          parameters: >
            {
              "containerRegistryName": "${{ env.ACR_REGISTRY_NAME }}",
              "containerImage": "${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.image_tag }}",
              "prefix": "${{ needs.setup.outputs.azure_prefix }}",
              "sku": "${{ needs.setup.outputs.sku }}",
              "envName": "${{ needs.setup.outputs.env_name }}"
            }
          environment: azureCloud
