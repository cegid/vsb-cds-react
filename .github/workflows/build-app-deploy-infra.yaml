#
# Only N images will be kept in the Container Registry (if older than 1 day).
# The cleanup task is ran as part of each pipeline execution.
#

name: Storybook - Build and Deploy
run-name: Storybook - Build and Deploy

env:
  ACR_REGISTRY_NAME: vsbdevtest.azurecr.io
  NUMBER_OF_IMAGES_TO_KEEP: 5
  SUBSCRIPTION_ID: 84643fb7-3439-48b6-96f2-8b50565881fc
  SKU: P0V3
  ENV_NAME: demo
  IMAGE_NAME: vsb-cds-react-storybook
  AZURE_PREFIX: vsbstorybook
  IMAGE_TAG: ${{ github.event.inputs.SKIP_BUILD == 'true' && 'latest' || github.sha }}
  SKIP_BUILD: ${{ github.event.inputs.SKIP_BUILD || false }}

on:
  workflow_dispatch:
    inputs:
      SKIP_BUILD:
        description: "Skip build and deploy latest image"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    environment:
      name: demo

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: env.SKIP_BUILD == 'false'
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - name: Login via Azure CLI
        if: env.SKIP_BUILD == 'false'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials
        if: env.SKIP_BUILD == 'false'
        id: get-acr-credentials
        run: |
          ACR_USERNAME=$(az acr credential show -n ${{ env.ACR_REGISTRY_NAME }} --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show -n ${{ env.ACR_REGISTRY_NAME }} --query "passwords[0].value" -o tsv)
          echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_ENV
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_ENV

      - name: Azure Container Registry Login
        if: env.SKIP_BUILD == 'false'
        uses: Azure/docker-login@v2
        with:
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}
          login-server: ${{ env.ACR_REGISTRY_NAME }}

      - name: Purge images in container registry - keep ${{ env.NUMBER_OF_IMAGES_TO_KEEP }}
        if: env.SKIP_BUILD == 'false'
        uses: Azure/cli@v2.1.0
        with:
          inlineScript: |
            PURGE_CMD="acr purge --filter '${{ env.IMAGE_NAME }}:.*' --ago 1d --keep ${{ env.NUMBER_OF_IMAGES_TO_KEEP }}"
            az acr run --cmd "$PURGE_CMD" --registry ${{ env.ACR_REGISTRY_NAME }} /dev/null

      - name: Build and push container image to registry
        if: env.SKIP_BUILD == 'false'
        uses: docker/build-push-action@0565240e2d4ab88bba5387d719585280857ece09 # v5.0.0
        with:
          push: true
          context: .
          tags: |
            ${{ env.ACR_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.ACR_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest
          file: Dockerfile
          build-args: |
            NPM_AUTH_TOKEN=${{ secrets.VSB_NPM_AUTH_TOKEN }}
            NPM_AUTH_EMAIL=${{ secrets.VSB_NPM_AUTH_EMAIL }}

  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: demo
      url: ${{ steps.bicep-deploy.outputs.webAppUrl }}

    steps:
      - uses: actions/checkout@v4

      - name: Log into Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create --name vsb-${{ env.AZURE_PREFIX }}-rg --location francecentral

      - name: Bicep Deploy
        id: bicep-deploy
        uses: Azure/bicep-deploy@v2
        with:
          type: deployment
          operation: create
          name: infra
          scope: resourceGroup
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
          resource-group-name: vsb-${{ env.AZURE_PREFIX }}-rg
          template-file: ./infra/infra.bicep
          parameters: >
            {
              "containerRegistryName": "${{ env.ACR_REGISTRY_NAME }}",
              "containerImage": "${{ env.IMAGE_NAME }}:${{ github.sha }}",
              "prefix": "${{ env.AZURE_PREFIX }}",
              "sku": "${{ env.SKU }}",
              "envName": "${{ env.ENV_NAME }}"
            }
          environment: azureCloud
